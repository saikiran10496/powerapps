name: Deploy Power Platform Solution new
on:
  push:
    branches:
      - main
jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Install Power Platform tools
      uses: microsoft/powerplatform-actions/actions-install@v1
    
    - name: Export Solution
      uses: microsoft/powerplatform-actions/export-solution@v1
      with:
        environment-url: "https://org9df2a3ac.crm.dynamics.com"
        app-id: ${{ secrets.CLIENT_ID }}
        client-secret: ${{ secrets.CLIENT_SECRET }}
        tenant-id: ${{ secrets.TENANT_ID }}
        solution-name: "sol1"
        solution-output-file: "exported-solution.zip"
        managed: false
    
    - name: Unpack Solution
      uses: microsoft/powerplatform-actions/unpack-solution@v1
      with:
        solution-file: "exported-solution.zip"
        solution-folder: "./sourceControl"
        solution-type: "Unmanaged"
    
    - name: Pack Solution
      uses: microsoft/powerplatform-actions/pack-solution@v1
      with:
        solution-folder: "./sourceControl"
        solution-file: "packed-solution.zip"
        solution-type: "Unmanaged"
    
    - name: Import Solution
      uses: microsoft/powerplatform-actions/import-solution@v1
      with:
        environment-url: "https://org4174b73a.crm.dynamics.com"
        app-id: ${{ secrets.CLIENT_ID }}
        client-secret: ${{ secrets.CLIENT_SECRET }}
        tenant-id: ${{ secrets.TENANT_ID }}
        solution-file: "packed-solution.zip"
        activate-plugins: true
        force-overwrite: true

    - name: Publish Customizations in Target Env
      uses: microsoft/powerplatform-actions/publish-customizations@v1
      with:
        environment-url: "https://org4174b73a.crm.dynamics.com" 
        app-id: ${{ secrets.CLIENT_ID }}
        client-secret: ${{ secrets.CLIENT_SECRET }}
        tenant-id: ${{ secrets.TENANT_ID }}
